image: maven:3-jdk-11

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

stages:
  - build
  - test

sonarcloud-check:
  stage: build

  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=damman96_RestaurantManager
  only:
    - merge_requests
    - master
    - develop

build-job-ubuntu:
  stage: build

  script: "mvn clean install -D=skipTests"

test-job-unit-ubuntu:
  stage: test
  needs: [ "build-job-ubuntu" ]

  script: "mvn test '-Dtest=!*TestIT*'"

test-job-IT-ubuntu:
  stage: test
  needs: [ "build-job-ubuntu", "test-job-unit-ubuntu" ]

  services:
    - postgres:latest

  variables:
    POSTGRES_DB: restaurant
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: admin

  script: "mvn test '-Dtest=*TestIT*' '-Dspring.profiles.active=gitlab'"

test-job-all-ubuntu:
  stage: test
  needs: [ "build-job-ubuntu", "test-job-unit-ubuntu", "test-job-IT-ubuntu" ]

  services:
    - postgres:latest

  variables:
    POSTGRES_DB: restaurant
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: admin

  script: "mvn test '-Dtest=*Test*' '-Dspring.profiles.active=gitlab'"
